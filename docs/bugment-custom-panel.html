<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Augment - Bugment é…ç½®</title>
  <script nonce="nonce-HKpiL9ffRsG6GgQ9TWd7rQ==">
    /**
     * Monaco bootstrap script
     *
     * This script is included directly in HTML files to load Monaco editor.
     * It's kept as a simple JS file to avoid any build/transpilation requirements.
     */

    // ========== æ‰“åŒ…é…ç½®å¸¸é‡ ==========
    const SHOW_MODEL_ID = true; // æ˜¯å¦åœ¨æ¨¡å‹åˆ—è¡¨ä¸­æ˜¾ç¤ºæ¨¡å‹ID

    // Define the Monaco CDN version
    const MONACO_VERSION = "0.52.2";
    const MONACO_CDN_BASE = `https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/${MONACO_VERSION}/min`;

    // Initialize augmentDeps if it doesn't exist
    window.augmentDeps = window.augmentDeps || {};

    // Create a promise that will resolve when Monaco is ready
    let monacoResolve;
    window.augmentDeps.monaco = new Promise((resolve) => {
      monacoResolve = resolve;
    });

    // If Monaco is already loaded, don't load it again
    if (window.monaco) {
      console.log("Monaco already loaded, skipping bootstrap");
      initializeMonacoDeps();
    } else {
      // Load the Monaco loader script
      const loaderScript = document.createElement("script");
      loaderScript.src = `${MONACO_CDN_BASE}/vs/loader.min.js`;
      loaderScript.onload = initializeMonaco;
      document.head.appendChild(loaderScript);
    }

    // Initialize Monaco after the loader script has loaded
    function initializeMonaco() {
      // require is provided by loader.min.js
      require.config({
        paths: { vs: `${MONACO_CDN_BASE}/vs` },
      });

      require(["vs/editor/editor.main"], () => {
        initializeMonacoDeps();
      });
    }

    // Initialize Monaco dependencies
    function initializeMonacoDeps() {
      window.augmentDeps.monaco.resolve = monacoResolve;
      monacoResolve(window.monaco);
    }

  </script>
  <meta property="csp-nonce" nonce="nonce-HKpiL9ffRsG6GgQ9TWd7rQ==">
  <style nonce="nonce-HKpiL9ffRsG6GgQ9TWd7rQ==">
    /* Global Reset & Typography */
    :root {
      --radius-base: 4px;
      --spacing-base: 16px;
    }

    body {
      font-family: var(--vscode-font-family, "Segoe UI", Tahoma, Geneva, Verdana, sans-serif);
      font-size: var(--vscode-font-size, 13px);
      color: var(--vscode-foreground);
      background-color: var(--vscode-editor-background);
      margin: 0;
      padding: 24px;
      line-height: 1.4;
    }

    .container {
      max-width: 720px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Modern Header */
    .header {
      display: flex;
      align-items: center;
      gap: 16px;
      padding-bottom: 24px;
      margin-bottom: 8px;
      border-bottom: 1px solid var(--vscode-widget-border);
    }

    .header-icon {
      font-size: 36px;
      line-height: 1;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    .header-content {
      display: flex;
      flex-direction: column;
    }

    .header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: var(--vscode-editor-foreground);
      letter-spacing: -0.2px;
    }

    .header-subtitle {
      font-size: 13px;
      color: var(--vscode-descriptionForeground);
      margin-top: 4px;
    }

    /* Modern Card */
    .card {
      background-color: var(--vscode-editor-background);
      border: 1px solid var(--vscode-widget-border);
      border-radius: var(--radius-base);
      padding: 0;
      overflow: hidden;
      transition: box-shadow 0.2s, border-color 0.2s;
    }

    .card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      border-color: var(--vscode-focusBorder);
    }

    .card-header {
      padding: 16px 20px;
      background-color: var(--vscode-editor-lineHighlightBackground);
      border-bottom: 1px solid var(--vscode-widget-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card h2 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--vscode-foreground);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Support direct h2 in card without .card-header wrapper */
    .card > h2 {
        padding: 16px 20px;
        background-color: var(--vscode-editor-lineHighlightBackground);
        border-bottom: 1px solid var(--vscode-widget-border);
    }

    .config-section, .content-body {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Form Elements */
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .input-group label {
      font-size: 12px;
      font-weight: 600;
      color: var(--vscode-input-foreground);
    }

    input[type="text"],
    input[type="password"],
    input[type="number"],
    select,
    textarea {
      background-color: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      border: 1px solid var(--vscode-input-border);
      border-radius: 2px;
      padding: 6px 10px;
      font-family: var(--vscode-font-family);
      font-size: 13px;
      width: 100%;
      box-sizing: border-box;
      outline: none;
      transition: border-color 0.15s;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--vscode-focusBorder);
      outline: 1px solid var(--vscode-focusBorder);
      outline-offset: -1px;
    }

    ::placeholder {
        color: var(--vscode-input-placeholderForeground);
    }

    /* Buttons */
    .button {
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border: none;
      border-radius: 2px;
      padding: 6px 16px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      text-decoration: none;
      height: 28px;
      box-sizing: border-box;
    }

    .button:hover {
      background-color: var(--vscode-button-hoverBackground);
    }

    .button.secondary {
      background-color: var(--vscode-button-secondaryBackground);
      color: var(--vscode-button-secondaryForeground);
    }

    .button.secondary:hover {
      background-color: var(--vscode-button-secondaryHoverBackground);
    }

    .button.small {
      padding: 0 10px;
      height: 24px;
      font-size: 12px;
    }

    .button-group {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }

    /* Status & Info */
    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--vscode-widget-border);
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .info-row .label {
      color: var(--vscode-descriptionForeground);
      font-size: 13px;
    }

    .info-row .value {
        font-weight: 500;
        font-family: var(--vscode-editor-font-family, monospace);
        font-size: 13px;
    }

    .config-status {
      padding: 8px 12px;
      border-radius: 2px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      min-height: 20px;
      margin-top: 8px;
    }

    .config-status:empty {
        display: none;
    }

    .config-status.success { color: var(--vscode-testing-iconPassed); background-color: rgba(0,255,0,0.1); }
    .config-status.error { color: var(--vscode-errorForeground); background-color: rgba(255,0,0,0.1); }
    .config-status.warning { color: var(--vscode-editorWarning-foreground); background-color: rgba(255,200,0,0.1); }

    .activation-status { font-weight: 600; }
    .activation-status.activated { color: var(--vscode-testing-iconPassed); }
    .activation-status.pending { color: var(--vscode-descriptionForeground); }
    .activation-status.expired { color: var(--vscode-editorWarning-foreground); }
    .activation-status.not-activated { color: var(--vscode-errorForeground); }

    /* Utility Helpers */
    .input-with-button { display: flex; gap: 8px; }
    .input-with-button input { flex: 1; }

    .input-hint {
        margin-top: 8px;
        font-size: 12px;
        color: var(--vscode-descriptionForeground);
        line-height: 1.4;
        display: flex;
        align-items: flex-start;
        gap: 6px;
    }

    .hidden { display: none !important; }

    /* Animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .content {
      display: flex;
      flex-direction: column;
      gap: 20px;
      animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    /* Activation Textarea */
    #activation-code-input {
      font-family: var(--vscode-editor-font-family, 'SF Mono', Monaco, Consolas, monospace);
      font-size: 12px;
      line-height: 1.5;
      min-height: 120px;
      resize: vertical;
      white-space: pre-wrap;
    }
    /* Augment Balance Styles */
    .balance-info {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 12px 20px 20px 20px;
    }

    .balance-amount {
      font-size: 24px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .balance-amount.positive {
      color: var(--vscode-testing-iconPassed);
    }

    .balance-amount.low {
      color: var(--vscode-editorWarning-foreground);
    }

    .balance-amount.negative {
      color: var(--vscode-errorForeground);
    }

    .balance-status {
      font-size: 14px;
      color: var(--vscode-descriptionForeground);
    }

    .account-info {
      display: flex;
      flex-direction: column;
      gap: 0;
      padding: 12px 20px 20px 20px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="header-icon">ğŸš€</div>
      <div class="header-content">
        <h1>Bugment Control Center</h1>
        <div class="header-subtitle">Manage your models, activation, and settings</div>
      </div>
    </div>

    <div class="content">
      <!-- æ¨¡å‹é…ç½®å¡ç‰‡ -->
      <div class="card" id="model-config-card">
        <div class="card-header">
          <h2>ğŸ¤– æ¨¡å‹é…ç½®</h2>
          <button class="button small" onclick="refreshModelConfig()">ğŸ”„ åˆ·æ–°</button>
        </div>
        <div class="config-section">
          <div class="input-group">
            <label for="base-url-input">Base URL:</label>
            <input type="text" id="base-url-input" placeholder="e.g. http://127.0.0.1:8317">
          </div>

          <!-- API Key è¾“å…¥æ¡† -->
          <div class="input-group">
            <label for="api-key-input">API Key:</label>
            <div class="input-with-button">
              <input type="password" id="api-key-input" placeholder="sk-..." value="sk-dummy">
              <button id="toggle-api-key" class="button secondary small" onclick="toggleApiKeyVisibility()">ğŸ‘ï¸</button>
            </div>
          </div>

          <div class="button-group">
            <button class="button secondary" id="load-models-btn" onclick="loadModels()">åŠ è½½æ¨¡å‹</button>
          </div>
          <div class="config-status" id="load-models-status"></div>

          <!-- æ¨¡å‹åˆ—è¡¨åŒºåŸŸ -->
          <div id="models-list-container" style="display: none; margin-top: 16px;">
            <div class="input-group">
              <label>å¯ç”¨æ¨¡å‹åˆ—è¡¨ï¼š</label>
              <div class="models-actions" style="display: flex; gap: 8px; margin-bottom: 8px;">
                <button class="button small secondary" onclick="toggleAllModels(true)">å…¨éƒ¨å¯ç”¨</button>
                <button class="button small secondary" onclick="toggleAllModels(false)">å…¨éƒ¨ç¦ç”¨</button>
              </div>
            </div>
            <div id="models-list" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--vscode-input-border); border-radius: 4px; padding: 8px;"></div>
          </div>

          <!-- åº”ç”¨é…ç½®æŒ‰é’®ï¼ˆåŠ è½½æ¨¡å‹åæ˜¾ç¤ºï¼‰ -->
          <div id="apply-config-container" style="display: none; margin-top: 16px;">
            <div class="button-group">
              <button class="button" onclick="applyModelConfig()">åº”ç”¨é…ç½®</button>
              <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--vscode-descriptionForeground); cursor: pointer;">
                <input type="checkbox" id="auto-login-checkbox" style="cursor: pointer;">
                è‡ªåŠ¨ç™»å½• Augment è´¦å·
              </label>
            </div>
            <div class="config-status" id="model-config-status"></div>
          </div>
        </div>
      </div>

      <!-- ç³»ç»Ÿæ¿€æ´»å¡ç‰‡ - ç½®é¡¶æ˜¾ç¤º -->
      <div class="card" id="activation-card" style="display: none;">
        <h2>ğŸ” ç³»ç»Ÿæ¿€æ´»</h2>
        <div class="config-section">
          <div class="info-row">
            <span class="label">æ¿€æ´»çŠ¶æ€:</span>
            <span class="value" id="activation-status">
              <span class="loading">â³ æ£€æŸ¥ä¸­...</span>
            </span>
          </div>
          <div class="info-row">
            <span class="label">æœºå™¨ID:</span>
            <span class="value" id="machine-id">-</span>
            <button class="copy-button" onclick="copyMachineId()" title="å¤åˆ¶æœºå™¨ID">ğŸ“‹ å¤åˆ¶</button>
          </div>
          <div class="info-row" id="activation-date-row" style="display: none;">
            <span class="label">æ¿€æ´»æ—¶é—´:</span>
            <span class="value" id="activation-date">-</span>
          </div>

          <div id="activation-input-section" style="display: none;">
            <div class="input-group">
              <label for="activation-code-input">ç­¾åæ¿€æ´»ç  (JWS):</label>
              <textarea id="activation-code-input"
                placeholder="ç²˜è´´ä»¥ . åˆ†éš”çš„ç­¾åæ¿€æ´»ç  (JWS)&#10;&#10;ç¤ºä¾‹æ ¼å¼ï¼š&#10;eyJhbGciOiJFZERTQSIsImtpZCI6Im1haW4ifQ.&#10;eyJzdWIiOiJWSVAtRDlGRi05ODdGLThGNEUiLCJpYXQiOjE3NTc2MDk1NzUsImV4cCI6MTc2MDIwMTU3NSwianRpIjoiNjc1NjBjOTktOTNmOS00YjBkLWJjMWMtNWE2MjgxNzZkNGE4IiwicGtoIjoiODNwSk1pREZIaTRqbGRlbFJWT2o1MlJVX1piZFNjcGJZcm9KNUJZYzJ6OCIsImVkaXRpb24iOiJWSVAifQ.&#10;7ueSdpTmLr5nL0-rXXbmg5HNh9crCY2Ss6Dqu3OxBqQgqltovsuIiH_OmOV03izvotPGR5QTc2Lr4QeSqQg1DA"
                rows="6"></textarea>
              <div class="input-hint">
                <span>ğŸ’¡</span>
                <span><strong>æç¤ºï¼š</strong>æ¿€æ´»ç å¾ˆé•¿ï¼Œå¯ä»¥ç›´æ¥ç²˜è´´æ•´ä¸ªJWSä»¤ç‰Œã€‚æ”¯æŒæ¢è¡Œæ˜¾ç¤ºï¼Œæ–¹ä¾¿æŸ¥çœ‹å„ä¸ªéƒ¨åˆ†ã€‚</span>
              </div>
            </div>
            <div class="button-group">
              <button class="button" onclick="activateSystem()">æ¿€æ´»ç³»ç»Ÿ</button>
              <button class="button secondary" onclick="clearActivationInput()">æ¸…ç©º</button>
            </div>
          </div>

          <div id="activation-success-section" style="display: none;">
            <div class="button-group">
              <button class="button secondary small" onclick="copyMachineId()">å¤åˆ¶æœºå™¨ID</button>
            </div>
          </div>

          <div class="config-status" id="activation-status-message"></div>
        </div>
      </div>

      <!-- ä¿¡æ¯é¢æ¿ - æ‰€æœ‰ç‰ˆæœ¬å¯ç”¨ -->
      <div class="card" id="info-panel-card" style="display: none;">
        <h2>ğŸš€ Augment ä¿¡æ¯é¢æ¿</h2>

        <div class="config-section">
          <div class="info-row">
            <span class="label">æ‰©å±•ç‰ˆæœ¬:</span>
            <span class="value" id="extension-version">æœªçŸ¥</span>
          </div>
          <div class="info-row">
            <span class="label">å®‰è£…æ—¶é—´:</span>
            <span class="value" id="install-time">æœªçŸ¥</span>
          </div>
        </div>
      </div>

      <div class="card" id="balance-card" style="display: none;">
        <div class="card-header">
          <h2>ğŸ’³ ä½™é¢ä¿¡æ¯</h2>
          <button class="button small" onclick="refreshBalance()">ğŸ”„ åˆ·æ–°</button>
        </div>
        <div class="account-info">
          <div class="info-row">
            <span class="label">å½“å‰ä½™é¢:</span>
            <span class="value" id="balance-amount"><span class="loading">â³ åŠ è½½ä¸­...</span></span>
          </div>
          <div class="info-row" id="balance-status-row" style="display: none;">
            <span class="label">çŠ¶æ€:</span>
            <span class="value" id="balance-status"></span>
          </div>
          <div class="info-row">
            <span class="label">ä»¤ç‰Œåç§°:</span>
            <span class="value" id="account-email">-</span>
          </div>
          <div class="info-row">
            <span class="label">å¥—é¤ç±»å‹:</span>
            <span class="value" id="account-plan">-</span>
          </div>
          <div class="info-row">
            <span class="label">åˆ°æœŸæ—¶é—´:</span>
            <span class="value" id="account-expiry">-</span>
          </div>
        </div>
        <div class="config-status" id="config-status" style="margin-top: 10px; font-size: 12px; color: var(--vscode-descriptionForeground);">
          æç¤ºï¼šä½¿ç”¨æ¨¡å‹é…ç½®ä¸­çš„ Base URL å’Œ API Key æŸ¥è¯¢ä½™é¢
        </div>
      </div>

      <!-- æ¨¡å‹é…ç½®å¡ç‰‡ (å·²ç§»åŠ¨åˆ°é¡¶éƒ¨) -->


      <div class="card" style="display: none;">
        <h2>åŠŸèƒ½ç‰¹æ€§</h2>
        <p>æ­¤é¢æ¿æ”¯æŒä¸ VSCode æ’ä»¶çš„åŒå‘é€šä¿¡ï¼Œå¯ä»¥å®ç°å¤æ‚çš„äº¤äº’åŠŸèƒ½ã€‚</p>

        <div class="info-section">
          <div class="info-item">
            <h3>ğŸ“Š æ•°æ®å±•ç¤º</h3>
            <span>æ”¯æŒå„ç§æ•°æ®å¯è§†åŒ–ç»„ä»¶</span>
          </div>

          <div class="info-item">
            <h3>âš™ï¸ é…ç½®ç®¡ç†</h3>
            <span>ç®¡ç†æ’ä»¶è®¾ç½®å’Œç”¨æˆ·åå¥½</span>
          </div>

          <div class="info-item">
            <h3>ğŸ”§ å·¥å…·é›†æˆ</h3>
            <span>é›†æˆå„ç§å¼€å‘å·¥å…·å’ŒæœåŠ¡</span>
          </div>

          <div class="info-item">
            <h3>ğŸ“ å†…å®¹ç¼–è¾‘</h3>
            <span>æ”¯æŒå¯Œæ–‡æœ¬å’Œä»£ç ç¼–è¾‘</span>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script nonce="nonce-HKpiL9ffRsG6GgQ9TWd7rQ==">
    // VSCode API
    const vscode = acquireVsCodeApi();

    function getLocalModelConfig() {
      try {
        const state = vscode.getState();
        return state && state.modelConfig ? state.modelConfig : null;
      } catch (error) {
        return null;
      }
    }

    function saveLocalModelConfig(config) {
      try {
        const state = vscode.getState() || {};
        vscode.setState({ ...state, modelConfig: config });
      } catch (error) {
        console.warn('[PANEL] æœ¬åœ°é…ç½®ç¼“å­˜å†™å…¥å¤±è´¥:', error);
      }
    }

    function isDifferentModelConfig(left, right) {
      const leftConfig = left || {};
      const rightConfig = right || {};
      return (leftConfig.base_url || '') !== (rightConfig.base_url || '') ||
        (leftConfig.api_key || '') !== (rightConfig.api_key || '') ||
        Boolean(leftConfig.useRemoteService) !== Boolean(rightConfig.useRemoteService);
    }

    function updateModelConfigStatus(type, message) {
      const status = document.getElementById('model-config-status');
      if (!status) return;
      status.className = 'config-status' + (type ? ` ${type}` : '');
      status.textContent = message || '';
    }

    function showMessage() {
      vscode.postMessage({
        command: 'showMessage',
        text: 'æ¥è‡ªè‡ªå®šä¹‰é¢æ¿çš„æ¶ˆæ¯ï¼'
      });
    }

    function refreshBalance() {
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      document.getElementById('balance-amount').innerHTML = '<span class="loading">â³ åˆ·æ–°ä¸­...</span>';
      document.getElementById('balance-status').textContent = '';
      document.getElementById('balance-status-row').style.display = 'none';

      // è¯·æ±‚ç§¯åˆ†ä¿¡æ¯
      vscode.postMessage({
        command: 'refreshBalance'
      });
    }

    function updateBalanceDisplay(balance, status) {
      const balanceElement = document.getElementById('balance-amount');
      const statusElement = document.getElementById('balance-status');
      const statusRowElement = document.getElementById('balance-status-row');

      if (balance !== null && balance !== undefined) {
        const balanceValue = parseFloat(balance);
        balanceElement.textContent = `$${balanceValue.toFixed(2)}`;

        // æ ¹æ®å‰©ä½™ä½™é¢è®¾ç½®é¢œè‰²
        balanceElement.className = 'value';
        if (balanceValue > 10) {
          balanceElement.style.color = 'var(--vscode-testing-iconPassed)';
        } else if (balanceValue > 0) {
          balanceElement.style.color = 'var(--vscode-editorWarning-foreground)';
        } else {
          balanceElement.style.color = 'var(--vscode-errorForeground)';
        }

        // æ˜¾ç¤ºçŠ¶æ€è¡Œï¼ˆå¦‚æœæœ‰çŠ¶æ€ä¿¡æ¯ï¼‰
        if (status) {
          statusElement.textContent = status;
          statusRowElement.style.display = 'flex';
        } else {
          statusRowElement.style.display = 'none';
        }
      } else {
        balanceElement.innerHTML = '<span class="error">è·å–å¤±è´¥</span>';
        statusElement.textContent = status || 'æ— æ³•è·å–ä½™é¢ä¿¡æ¯';
        statusRowElement.style.display = 'flex';
      }
    }

    function updateAccountDisplay(accountInfo) {
      if (accountInfo) {
        document.getElementById('account-email').textContent = accountInfo.name || accountInfo.email || '-';
        document.getElementById('account-plan').textContent = accountInfo.plan_name || '-';

        if (accountInfo.end_date) {
          document.getElementById('account-expiry').textContent = accountInfo.end_date;
        } else {
          document.getElementById('account-expiry').textContent = 'æ°¸ä¹…æœ‰æ•ˆ';
        }
      }
    }

    function openSettings() {
      vscode.postMessage({
        command: 'openSettings'
      });
    }



    function toggleTokenVisibility() {
      const input = document.getElementById('api-token-input');
      const button = event.target;

      if (input.type === 'password') {
        input.type = 'text';
        button.textContent = 'ğŸ™ˆ';
      } else {
        input.type = 'password';
        button.textContent = 'ğŸ‘ï¸';
      }
    }

    function saveToken() {
      const token = document.getElementById('api-token-input').value.trim();
      const baseUrl = document.getElementById('api-base-url-input').value.trim();
      const statusDiv = document.getElementById('config-status');

      if (!token) {
        statusDiv.className = 'config-status warning';
        statusDiv.textContent = 'âš ï¸ è¯·è¾“å…¥ API Key';
        return;
      }

      // æ£€æŸ¥æ˜¯å¦é…ç½®äº† Base URL
      if (!baseUrl) {
        statusDiv.className = 'config-status warning';
        statusDiv.textContent = 'âš ï¸ è¯·é…ç½® Base URL';
        return;
      }

      statusDiv.className = 'config-status';
      statusDiv.textContent = 'â³ ä¿å­˜ä¸­...';

      vscode.postMessage({
        command: 'saveToken',
        token: token,
        baseUrl: baseUrl
      });
    }

    function testToken() {
      const token = document.getElementById('api-token-input').value.trim();
      const baseUrl = document.getElementById('api-base-url-input').value.trim();
      const statusDiv = document.getElementById('config-status');

      if (!token) {
        statusDiv.className = 'config-status warning';
        statusDiv.textContent = 'âš ï¸ è¯·å…ˆè¾“å…¥ API Key';
        return;
      }

      statusDiv.className = 'config-status';
      statusDiv.textContent = 'â³ æµ‹è¯•è¿æ¥ä¸­...';

      vscode.postMessage({
        command: 'testToken',
        token: token,
        baseUrl: baseUrl
      });
    }

    function loadCurrentToken() {
      vscode.postMessage({
        command: 'getCurrentToken'
      });
    }

    // æ¿€æ´»ç›¸å…³åŠŸèƒ½
    function refreshActivationStatus() {
      console.log('[PANEL] ğŸ”„ refreshActivationStatus è¢«è°ƒç”¨');
      console.log('[PANEL] è®¾ç½®çŠ¶æ€ä¸º"æ£€æŸ¥ä¸­..."');
      document.getElementById('activation-status').innerHTML = '<span class="loading">â³ æ£€æŸ¥ä¸­...</span>';

      console.log('[PANEL] å‘é€ getActivationStatus æ¶ˆæ¯åˆ°åç«¯');
      vscode.postMessage({
        command: 'getActivationStatus'
      });
      console.log('[PANEL] âœ… getActivationStatus æ¶ˆæ¯å·²å‘é€');
    }





    function activateSystem() {
      const activationCodeRaw = document.getElementById('activation-code-input').value;
      const statusDiv = document.getElementById('activation-status-message');

      if (!activationCodeRaw) {
        statusDiv.className = 'config-status warning';
        statusDiv.textContent = 'âš ï¸ è¯·è¾“å…¥æ¿€æ´»ç ';
        return;
      }

      // æ¸…ç†æ¿€æ´»ç ï¼šç§»é™¤æ¢è¡Œç¬¦ã€ç©ºæ ¼ç­‰ï¼Œåªä¿ç•™JWSå†…å®¹
      const activationCode = activationCodeRaw
        .replace(/\s+/g, '') // ç§»é™¤æ‰€æœ‰ç©ºç™½å­—ç¬¦
        .replace(/[\r\n]/g, '') // ç§»é™¤æ¢è¡Œç¬¦
        .trim();

      if (!activationCode) {
        statusDiv.className = 'config-status warning';
        statusDiv.textContent = 'âš ï¸ æ¿€æ´»ç ä¸èƒ½ä¸ºç©º';
        return;
      }

      // éªŒè¯ JWS åŸºæœ¬æ ¼å¼ï¼šä¸‰æ®µ Base64URLï¼Œç”¨ç‚¹å·åˆ†éš”
      if (!/^[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+$/.test(activationCode)) {
        statusDiv.className = 'config-status warning';
        statusDiv.textContent = 'âš ï¸ æ ¼å¼é”™è¯¯ï¼Œåº”ä¸ºç­¾åæ¿€æ´»ç  (ä¸‰æ®µä»¥ç‚¹åˆ†éš”çš„ JWS)';
        return;
      }

      // æ˜¾ç¤ºæ¸…ç†åçš„æ¿€æ´»ç é•¿åº¦ä¿¡æ¯
      const parts = activationCode.split('.');
      console.log(`[PANEL] æ¿€æ´»ç éªŒè¯é€šè¿‡: Header(${parts[0].length}) + Payload(${parts[1].length}) + Signature(${parts[2].length}) = ${activationCode.length} å­—ç¬¦`);

      statusDiv.className = 'config-status';
      statusDiv.textContent = 'â³ æ¿€æ´»ä¸­...';

      vscode.postMessage({
        command: 'activateSystem',
        activationCode: activationCode
      });
    }

    function clearActivationInput() {
      document.getElementById('activation-code-input').value = '';
      const statusDiv = document.getElementById('activation-status-message');
      statusDiv.className = 'config-status';
      statusDiv.textContent = '';
      console.log('[PANEL] æ¿€æ´»ç è¾“å…¥æ¡†å·²æ¸…ç©º');
    }

    function copyMachineId() {
      const machineId = document.getElementById('machine-id').textContent;
      if (machineId && machineId !== '-') {
        navigator.clipboard.writeText(machineId).then(() => {
          const statusDiv = document.getElementById('activation-status-message');
          statusDiv.className = 'config-status success';
          statusDiv.textContent = 'âœ… æœºå™¨IDå·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
          setTimeout(() => {
            statusDiv.textContent = '';
            statusDiv.className = 'config-status';
          }, 3000);
        }).catch(() => {
          // é™çº§æ–¹æ¡ˆï¼šé€‰ä¸­æ–‡æœ¬
          const element = document.getElementById('machine-id');
          const range = document.createRange();
          range.selectNode(element);
          window.getSelection().removeAllRanges();
          window.getSelection().addRange(range);
        });
      }
    }

    function updateActivationDisplay(activationInfo) {
      const statusElement = document.getElementById('activation-status');
      const machineIdElement = document.getElementById('machine-id');
      const activationDateRow = document.getElementById('activation-date-row');
      const activationDateElement = document.getElementById('activation-date');
      const inputSection = document.getElementById('activation-input-section');
      const successSection = document.getElementById('activation-success-section');

      // æ›´æ–°æœºå™¨ID
      if (activationInfo.machineId) {
        machineIdElement.innerHTML = `<span class="machine-id">${activationInfo.machineId}</span>`;
      }

      // ä½¿ç”¨æ–°çš„ activationStatus å­—æ®µæ¥åˆ¤æ–­çŠ¶æ€
      const status = activationInfo.activationStatus || (activationInfo.isActivated ? STATUS_STRINGS.ACTIVATED : STATUS_STRINGS.NOT_ACTIVATED);

      if (status === STATUS_STRINGS.ACTIVATED) {
        // å·²æ¿€æ´»çŠ¶æ€ - æ˜¾ç¤ºæ¿€æ´»ä¿¡æ¯ï¼ŒåŒæ—¶å…è®¸é‡æ–°æ¿€æ´»
        statusElement.innerHTML = '<span class="activation-status activated">âœ… å·²æ¿€æ´» (å¯é‡æ–°æ¿€æ´»)</span>';
        inputSection.style.display = 'block'; // ä»ç„¶æ˜¾ç¤ºè¾“å…¥æ¡†ï¼Œå…è®¸é‡å¤æ¿€æ´»
        successSection.style.display = 'block'; // æ˜¾ç¤ºå·²æ¿€æ´»çš„æ“ä½œæŒ‰é’®

        // ä¿®æ”¹æŒ‰é’®æ–‡å­—ä¸ºâ€œé‡æ–°æ¿€æ´»â€
        const activateButton = inputSection.querySelector('button[onclick="activateSystem()"]');
        if (activateButton) {
          activateButton.textContent = 'é‡æ–°æ¿€æ´»';
        }

        if (activationInfo.activationDate) {
          activationDateRow.style.display = 'flex';
          const date = new Date(activationInfo.activationDate);
          activationDateElement.textContent = date.toLocaleString();
        }

        // åœæ­¢å®šæ—¶æ›´æ–°ï¼ˆå·²æ¿€æ´»çŠ¶æ€ä¸éœ€è¦ç›‘æ§ï¼‰
        stopStatusTimer();
      } else if (status === STATUS_STRINGS.PENDING) {
        // å¾…æ¿€æ´»çŠ¶æ€ï¼ˆå®‰è£…å10åˆ†é’Ÿå†…ï¼‰
        statusElement.innerHTML = '<span class="activation-status pending">â³ å¾…æ¿€æ´»</span>';
        inputSection.style.display = 'block';
        successSection.style.display = 'none';
        activationDateRow.style.display = 'none';

        // æŒ‰é’®æ–‡å­—ä¸º"æ¿€æ´»ç³»ç»Ÿ"
        const activateButton = inputSection.querySelector('button[onclick="activateSystem()"]');
        if (activateButton) {
          activateButton.textContent = 'æ¿€æ´»ç³»ç»Ÿ';
        }

        // å¯åŠ¨å®šæ—¶æ›´æ–°ï¼ˆå¾…æ¿€æ´»çŠ¶æ€éœ€è¦ç›‘æ§è¯•ç”¨æœŸåˆ°æœŸï¼‰
        startStatusTimer();
      } else if (status === STATUS_STRINGS.EXPIRED) {
        // å·²è¿‡æœŸçŠ¶æ€ï¼ˆæ™®é€šç‰ˆæœ¬2å¤©åˆ°æœŸï¼‰
        statusElement.innerHTML = '<span class="activation-status expired">â° å·²è¿‡æœŸ (éœ€é‡æ–°æ¿€æ´»)</span>';
        inputSection.style.display = 'block';
        successSection.style.display = 'none';
        activationDateRow.style.display = 'none';

        // æŒ‰é’®æ–‡å­—ä¸º"é‡æ–°æ¿€æ´»"
        const activateButton = inputSection.querySelector('button[onclick="activateSystem()"]');
        if (activateButton) {
          activateButton.textContent = 'é‡æ–°æ¿€æ´»';
        }

        // å¯åŠ¨å®šæ—¶æ›´æ–°ï¼ˆè¿‡æœŸçŠ¶æ€éœ€è¦ç›‘æ§é‡æ–°æ¿€æ´»ï¼‰
        startStatusTimer();
      } else {
        // æœªæ¿€æ´»çŠ¶æ€
        statusElement.innerHTML = '<span class="activation-status not-activated">âŒ æœªæ¿€æ´»</span>';
        inputSection.style.display = 'block';
        successSection.style.display = 'none';
        activationDateRow.style.display = 'none';

        // é‡ç½®æŒ‰é’®æ–‡å­—ä¸ºâ€œæ¿€æ´»ç³»ç»Ÿâ€
        const activateButton = inputSection.querySelector('button[onclick="activateSystem()"]');
        if (activateButton) {
          activateButton.textContent = 'æ¿€æ´»ç³»ç»Ÿ';
        }

        // åœæ­¢å®šæ—¶æ›´æ–°ï¼ˆæœªæ¿€æ´»çŠ¶æ€ä¸éœ€è¦ç›‘æ§ï¼‰
        stopStatusTimer();
      }
    }

    // ç›‘å¬æ¥è‡ªæ’ä»¶çš„æ¶ˆæ¯
    window.addEventListener('message', event => {
      const message = event.data;
      switch (message.command) {
        case 'updateBalance':
          updateBalanceDisplay(message.balance, message.status);
          break;
        case 'updateAccount':
          updateAccountDisplay(message.accountInfo);
          break;
        case 'balanceError':
          updateBalanceDisplay(null, message.error);
          break;

        case 'activationStatus':
          updateActivationDisplay(message.activationInfo);
          break;
        case 'activationResult':
          const activationStatusDiv = document.getElementById('activation-status-message');
          if (message.success) {
            activationStatusDiv.className = 'config-status success';
            activationStatusDiv.textContent = 'ğŸ‰ ' + message.message;
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('activation-code-input').value = '';
            // åˆ·æ–°æ¿€æ´»çŠ¶æ€
            setTimeout(() => {
              refreshActivationStatus();
            }, 1000);
          } else {
            activationStatusDiv.className = 'config-status error';
            activationStatusDiv.textContent = 'âŒ ' + message.message;
          }
          break;
        case 'extensionInfo':
          console.log(`[PANEL] æ‰©å±•ä¿¡æ¯: ${message.displayName}, ç‰ˆæœ¬: ${message.version}`);

          // æ›´æ–°æ‰©å±•ç‰ˆæœ¬æ˜¾ç¤º
          document.getElementById('extension-version').textContent = message.version || 'æœªçŸ¥';

          // ç›´æ¥è¯»å–å½“å‰æ’ä»¶çš„package.jsonè·å–å®‰è£…æ—¶é—´
          loadInstallTimeFromPackageJson();

          // æ‰€æœ‰ç”¨æˆ·éƒ½æ˜¾ç¤ºå®Œæ•´åŠŸèƒ½ï¼Œä¸å†åŒºåˆ†VIP
          toggleVipFeatures(true);

          // åŠ è½½ä½™é¢ä¿¡æ¯
          refreshBalance();

          // æ˜¾ç¤ºæ‰€æœ‰åŠŸèƒ½é¢æ¿
          document.getElementById('info-panel-card').style.display = 'block';
          document.getElementById('balance-card').style.display = 'block';
          break;
        case 'installTimeFromPackageJson':
          // æ›´æ–°å®‰è£…æ—¶é—´æ˜¾ç¤º
          if (message.installTime) {
            const installDate = new Date(message.installTime).toLocaleString();
            document.getElementById('install-time').textContent = installDate;
            console.log(`[PANEL] ä»package.jsonè·å–å®‰è£…æ—¶é—´: ${installDate}`);
          } else {
            document.getElementById('install-time').textContent = 'æœªçŸ¥';
            console.log(`[PANEL] æ— æ³•ä»package.jsonè·å–å®‰è£…æ—¶é—´`);
          }
          break;
        case 'modelConfigLoaded':
          // æ¨¡å‹é…ç½®åŠ è½½å®Œæˆ
          console.log('[PANEL] æ”¶åˆ°æ¨¡å‹é…ç½®:', message);
          const localConfig = getLocalModelConfig();
          if (message.success && message.config) {
            const source = message.source || 'unknown';
            if ((source === 'default' || source === 'interceptor') &&
              localConfig &&
              isDifferentModelConfig(localConfig, message.config)) {
              updateModelConfigDisplay(localConfig);
              updateModelConfigStatus('warning', 'âš ï¸ æœªä» VSCode é…ç½®è¯»å–åˆ°å·²ä¿å­˜å€¼ï¼Œå·²å¡«å…¥æœ¬åœ°ç¼“å­˜ï¼Œè¯·ç‚¹å‡»â€œåº”ç”¨é…ç½®â€é‡æ–°ä¿å­˜');
            } else {
              updateModelConfigDisplay(message.config);
              if (source === 'vscode' || source === 'cache') {
                saveLocalModelConfig(message.config);
              }
            }
          } else if (localConfig) {
            updateModelConfigDisplay(localConfig);
            updateModelConfigStatus('warning', 'âš ï¸ æœªè¯»å–åˆ°é…ç½®ï¼Œå·²æ¢å¤æœ¬åœ°ç¼“å­˜ï¼Œè¯·ç‚¹å‡»â€œåº”ç”¨é…ç½®â€é‡æ–°ä¿å­˜');
          } else {
            console.log('[PANEL] æœªæ‰¾åˆ°å·²ä¿å­˜çš„æ¨¡å‹é…ç½®ï¼Œä½¿ç”¨é»˜è®¤');
            updateModelConfigDisplay(null);
          }
          break;
        case 'modelConfigSaved':
          // æ¨¡å‹é…ç½®ä¿å­˜ç»“æœ
          const modelStatusDiv = document.getElementById('model-config-status');
          if (message.success) {
            // æ›´æ–°æ˜¾ç¤º
            if (message.config) {
              updateModelConfigDisplay(message.config);
              saveLocalModelConfig(message.config);
            }
            if (message.persisted === false) {
              modelStatusDiv.className = 'config-status warning';
              modelStatusDiv.textContent = 'âš ï¸ é…ç½®å·²åº”ç”¨ï¼Œä½†æŒä¹…åŒ–å¤±è´¥ï¼š' + (message.persistError || 'æœªçŸ¥é”™è¯¯');
            } else {
              modelStatusDiv.className = 'config-status success';
              modelStatusDiv.textContent = 'âœ… é…ç½®å·²ä¿å­˜ï¼Œ2ç§’åé‡å¯æ’ä»¶...';
              // 2ç§’åé‡å¯æ‰©å±•å®¿ä¸»
              setTimeout(() => {
                vscode.postMessage({ command: 'reloadWindow' });
              }, 2000);
            }
          } else {
            modelStatusDiv.className = 'config-status error';
            modelStatusDiv.textContent = 'âŒ ä¿å­˜å¤±è´¥: ' + (message.error || 'æœªçŸ¥é”™è¯¯');
          }
          break;
        case 'modelsLoaded':
          // æ¨¡å‹åŠ è½½ç»“æœ
          const loadStatusDiv = document.getElementById('load-models-status');
          document.getElementById('load-models-btn').disabled = false;

          if (message.success) {
            loadStatusDiv.className = 'config-status success';
            loadStatusDiv.textContent = 'âœ… åŠ è½½æˆåŠŸï¼Œå…± ' + Object.keys(message.models).length + ' ä¸ªæ¨¡å‹';
            renderModelsList(message.models);
          } else {
            loadStatusDiv.className = 'config-status error';
            loadStatusDiv.textContent = 'âŒ åŠ è½½å¤±è´¥: ' + (message.error || 'æœªçŸ¥é”™è¯¯');
          }
          break;
      }
    });

    // æ£€æµ‹VIPç‰ˆæœ¬å¹¶æ§åˆ¶é¢æ¿æ˜¾ç¤º
    let initRetryCount = 0;
    let initTimer = null;

    function checkVipVersionAndShowPanels() {
      // ç«‹å³å‘é€ç¬¬ä¸€æ¬¡è¯·æ±‚
      sendInitMessages();

      // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å®šæ—¶å™¨
      if (initTimer) clearInterval(initTimer);

      // å¯åŠ¨é‡è¯•å¾ªç¯ (æ¯1ç§’é‡è¯•ä¸€æ¬¡ï¼Œæœ€å¤š5æ¬¡)
      initTimer = setInterval(() => {
        // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–æˆåŠŸ (é€šè¿‡æ£€æŸ¥æ‰©å±•ç‰ˆæœ¬æ˜¯å¦å·²æ›´æ–°)
        const isInitialized = document.getElementById('extension-version').textContent !== 'æœªçŸ¥';

        if (isInitialized) {
          console.log('[PANEL] âœ… åˆå§‹åŒ–æˆåŠŸï¼Œåœæ­¢é‡è¯•');
          clearInterval(initTimer);
          return;
        }

        if (initRetryCount >= 5) {
          console.log('[PANEL] âš ï¸ åˆå§‹åŒ–é‡è¯•æ¬¡æ•°è€—å°½ï¼Œåœæ­¢é‡è¯•');
          clearInterval(initTimer);
          return;
        }

        initRetryCount++;
        console.log(`[PANEL] â³ æœªæ”¶åˆ°å“åº”ï¼Œæ­£åœ¨é‡è¯•åˆå§‹åŒ– (${initRetryCount}/5)...`);
        sendInitMessages();
      }, 1000);
    }

    function sendInitMessages() {
      vscode.postMessage({ command: 'getExtensionInfo' });
      vscode.postMessage({ command: 'requestSystemInfo' });
    }

    // ========== æ¨¡å‹é…ç½®ç›¸å…³ ==========

    // åˆ·æ–°æ¨¡å‹é…ç½®æ˜¾ç¤º
    function refreshModelConfig() {
      console.log('[PANEL] åˆ·æ–°æ¨¡å‹é…ç½®...');
      vscode.postMessage({
        command: 'getModelConfig'
      });
    }
    function toggleApiKeyVisibility() {
      const input = document.getElementById('api-key-input');
      const btn = document.getElementById('toggle-api-key');
      if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = 'ğŸ”’'; // Click to hide
      } else {
        input.type = 'password';
        btn.textContent = 'ğŸ‘ï¸'; // Click to show
      }
    }

    /**
     * æ›´æ–°æ¨¡å‹é…ç½®æ˜¾ç¤º
     */
    function updateModelConfigDisplay(config) {
      console.log('[PANEL] æ›´æ–°æ¨¡å‹é…ç½®æ˜¾ç¤º:', config);

      // æ›´æ–° Base URL
      if (config && config.base_url) {
        document.getElementById('base-url-input').value = config.base_url;
      }

      // æ›´æ–° API Key
      if (config && config.api_key) {
        document.getElementById('api-key-input').value = config.api_key;
      } else {
        document.getElementById('api-key-input').value = 'sk-dummy';
      }

      console.log('[PANEL] é…ç½® UI å·²æ›´æ–°');
    }

    // æœ¬åœ°å­˜å‚¨çš„æ¨¡å‹å¯ç”¨çŠ¶æ€
    let modelsEnabledState = {};
    let loadedModels = {};

    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ¨¡å‹å¯ç”¨çŠ¶æ€
    function loadModelsEnabledState() {
      try {
        const saved = localStorage.getItem('bugment_models_enabled');
        if (saved) {
          modelsEnabledState = JSON.parse(saved);
        }
      } catch (e) {
        console.error('[PANEL] åŠ è½½æ¨¡å‹çŠ¶æ€å¤±è´¥:', e);
        modelsEnabledState = {};
      }
      return modelsEnabledState;
    }

    // ä¿å­˜æ¨¡å‹å¯ç”¨çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
    function saveModelsEnabledState() {
      try {
        localStorage.setItem('bugment_models_enabled', JSON.stringify(modelsEnabledState));
        // åŒæ—¶é€šçŸ¥åç«¯ä¿å­˜
        vscode.postMessage({
          command: 'saveModelsEnabledState',
          state: modelsEnabledState
        });
      } catch (e) {
        console.error('[PANEL] ä¿å­˜æ¨¡å‹çŠ¶æ€å¤±è´¥:', e);
      }
    }

    // åŠ è½½æ¨¡å‹åˆ—è¡¨
    function loadModels() {
      const statusDiv = document.getElementById('load-models-status');
      const baseUrl = document.getElementById('base-url-input').value.trim();
      const apiKey = document.getElementById('api-key-input').value.trim();

      if (!baseUrl) {
        statusDiv.className = 'config-status error';
        statusDiv.textContent = 'âŒ è¯·å…ˆè¾“å…¥ Base URL';
        return;
      }

      statusDiv.className = 'config-status';
      statusDiv.textContent = 'â³ æ­£åœ¨åŠ è½½æ¨¡å‹åˆ—è¡¨...';

      // ç¦ç”¨æŒ‰é’®
      document.getElementById('load-models-btn').disabled = true;

      vscode.postMessage({
        command: 'loadModels',
        baseUrl: baseUrl,
        apiKey: apiKey
      });
    }

    // æ¸²æŸ“æ¨¡å‹åˆ—è¡¨
    function renderModelsList(models) {
      loadedModels = models;
      loadModelsEnabledState();

      const container = document.getElementById('models-list');
      const listContainer = document.getElementById('models-list-container');
      const applyContainer = document.getElementById('apply-config-container');

      if (!models || Object.keys(models).length === 0) {
        container.innerHTML = '<div style="color: var(--vscode-descriptionForeground); padding: 8px;">æš‚æ— å¯ç”¨æ¨¡å‹</div>';
        listContainer.style.display = 'block';
        return;
      }

      // æŒ‰ priority æ’åº
      const sortedModels = Object.entries(models).sort((a, b) => {
        const priorityA = a[1].priority || 999;
        const priorityB = b[1].priority || 999;
        return priorityA - priorityB;
      });

      let html = '';
      for (const [modelId, modelInfo] of sortedModels) {
        // é»˜è®¤æ¨¡å‹å§‹ç»ˆå¯ç”¨ï¼Œå…¶ä»–é»˜è®¤å¯ç”¨é™¤éæ˜ç¡®ç¦ç”¨
        const isDefaultModel = modelInfo.isDefault === true;
        const isEnabled = isDefaultModel ? true : (modelsEnabledState[modelId] !== false);
        const isNew = modelInfo.isNew ? '<span style="color: #4CAF50; font-size: 10px; margin-left: 4px;">NEW</span>' : '';
        const isDefault = isDefaultModel ? '<span style="color: #2196F3; font-size: 10px; margin-left: 4px;">é»˜è®¤</span>' : '';

        // é»˜è®¤æ¨¡å‹çš„å¼€å…³ç¦ç”¨
        const switchDisabled = isDefaultModel ? 'disabled' : '';
        const switchCursor = isDefaultModel ? 'not-allowed' : 'pointer';
        const switchOpacity = isDefaultModel ? '0.6' : '1';

        html += `
          <div class="model-item" style="display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid var(--vscode-input-border);">
            <div style="flex: 1;">
              <div style="font-weight: 500;">${modelInfo.displayName || modelId}${isNew}${isDefault}</div>
              <div style="font-size: 11px; color: var(--vscode-descriptionForeground);">${modelInfo.description || ''}</div>
              ${SHOW_MODEL_ID ? `<div style="font-size: 10px; color: var(--vscode-descriptionForeground);">ID: ${modelId}</div>` : ''}
            </div>
            <label class="switch" style="position: relative; display: inline-block; width: 40px; height: 20px; opacity: ${switchOpacity};" ${isDefaultModel ? 'title="é»˜è®¤æ¨¡å‹ä¸èƒ½ç¦ç”¨"' : ''}>
              <input type="checkbox" ${isEnabled ? 'checked' : ''} ${switchDisabled} onchange="toggleModel('${modelId}', this.checked)" style="opacity: 0; width: 0; height: 0;">
              <span class="slider" style="position: absolute; cursor: ${switchCursor}; top: 0; left: 0; right: 0; bottom: 0; background-color: ${isEnabled ? '#4CAF50' : '#ccc'}; transition: .3s; border-radius: 20px;">
                <span style="position: absolute; content: ''; height: 14px; width: 14px; left: ${isEnabled ? '22px' : '3px'}; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%;"></span>
              </span>
            </label>
          </div>
        `;
      }

      container.innerHTML = html;
      listContainer.style.display = 'block';
      applyContainer.style.display = 'block';
    }

    // åˆ‡æ¢å•ä¸ªæ¨¡å‹çŠ¶æ€
    function toggleModel(modelId, enabled) {
      modelsEnabledState[modelId] = enabled;
      saveModelsEnabledState();
      // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æ ·å¼
      renderModelsList(loadedModels);
    }

    // å…¨éƒ¨å¯ç”¨/ç¦ç”¨
    function toggleAllModels(enabled) {
      for (const modelId of Object.keys(loadedModels)) {
        modelsEnabledState[modelId] = enabled;
      }
      saveModelsEnabledState();
      renderModelsList(loadedModels);
    }

    // åº”ç”¨æ¨¡å‹é…ç½®
    function applyModelConfig() {
      const statusDiv = document.getElementById('model-config-status');

      const config = {
        base_url: document.getElementById('base-url-input').value.trim(),
        api_key: document.getElementById('api-key-input').value.trim() || 'sk-dummy',
        autoLogin: document.getElementById('auto-login-checkbox').checked
      };

      statusDiv.className = 'config-status';
      statusDiv.textContent = 'â³ åº”ç”¨é…ç½®ä¸­...';

      vscode.postMessage({
        command: 'saveModelConfig',
        config: config
      });
    }

    // æ˜¾ç¤ºæˆ–éšè—VIPä¸“å±åŠŸèƒ½
    function toggleVipFeatures(isVip) {
      const vipElements = document.querySelectorAll('.vip-only');
      vipElements.forEach(element => {
        if (isVip) {
          element.style.display = 'block';
        } else {
          element.style.display = 'none';
        }
      });

      console.log(`[PANEL] æ‰€æœ‰åŠŸèƒ½${isVip ? 'å·²å¯ç”¨' : 'å·²éšè—'}`);
    }

    // ç›´æ¥è¯»å–å½“å‰æ’ä»¶çš„package.jsonè·å–å®‰è£…æ—¶é—´
    function loadInstallTimeFromPackageJson() {
      vscode.postMessage({
        command: 'getInstallTimeFromPackageJson'
      });
    }

    // å­—ç¬¦ä¸²è§£ç å‡½æ•° - é˜²æ­¢é™æ€åˆ†æ
    const decode = (str) => atob(str);
    const hex2str = (hex) => decodeURIComponent(hex.replace(/\s+/g, '').replace(/[0-9a-f]{2}/g, '%$&'));

    // ç¼–ç çš„çŠ¶æ€å­—ç¬¦ä¸²
    const STATUS_STRINGS = {
      ACTIVATED: decode('YWN0aXZhdGVk'), // 'activated'
      PENDING: decode('cGVuZGluZw=='), // 'pending'
      EXPIRED: decode('ZXhwaXJlZA=='), // 'expired'
      NOT_ACTIVATED: decode('bm90X2FjdGl2YXRlZA==') // 'not_activated'
    };

    // å®šæ—¶å™¨å˜é‡
    let statusUpdateTimer = null;

    // å¯åŠ¨çŠ¶æ€å®šæ—¶æ›´æ–°ï¼ˆä»…åœ¨å¾…æ¿€æ´»çŠ¶æ€ä¸‹ï¼‰
    function startStatusTimer() {
      // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
      if (statusUpdateTimer) {
        clearInterval(statusUpdateTimer);
      }

      // æ¯10ç§’æ›´æ–°ä¸€æ¬¡çŠ¶æ€
      statusUpdateTimer = setInterval(() => {
        console.log('[PANEL] å®šæ—¶æ›´æ–°æ¿€æ´»çŠ¶æ€...');
        refreshActivationStatus();
      }, 10000); // 10ç§’

      console.log('[PANEL] çŠ¶æ€å®šæ—¶å™¨å·²å¯åŠ¨ (æ¯10ç§’æ›´æ–°)');
    }

    // åœæ­¢çŠ¶æ€å®šæ—¶æ›´æ–°
    function stopStatusTimer() {
      if (statusUpdateTimer) {
        clearInterval(statusUpdateTimer);
        statusUpdateTimer = null;
        console.log('[PANEL] çŠ¶æ€å®šæ—¶å™¨å·²åœæ­¢');
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆåè¯·æ±‚ç³»ç»Ÿä¿¡æ¯å’Œç§¯åˆ†ä¿¡æ¯
    document.addEventListener('DOMContentLoaded', () => {
      console.log('[PANEL] ğŸ” DOM loaded, starting initialization...');
      console.log('[PANEL] å½“å‰æ—¶é—´:', new Date().toISOString());

      vscode.postMessage({
        command: 'requestSystemInfo'
      });

      // æ£€æµ‹VIPç‰ˆæœ¬
      checkVipVersionAndShowPanels();

      // ç«‹å³è§¦å‘æ¿€æ´»çŠ¶æ€æ£€æŸ¥ï¼ˆæ·»åŠ è¯Šæ–­ï¼‰
      console.log('[PANEL] ğŸš€ ç«‹å³è§¦å‘æ¿€æ´»çŠ¶æ€æ£€æŸ¥...');
      refreshActivationStatus();

      // åˆå§‹åŒ–æ¨¡å‹é€‰æ‹©å™¨å¹¶åŠ è½½å½“å‰é…ç½®
      console.log('[PANEL] ğŸ¤– åˆå§‹åŒ–æ¨¡å‹é€‰æ‹©å™¨...');
      refreshModelConfig();

      // VIPä¸“å±åŠŸèƒ½ï¼ˆå°†åœ¨æ”¶åˆ°æ‰©å±•ä¿¡æ¯åå†³å®šæ˜¯å¦åŠ è½½ï¼‰
      // loadCurrentToken();
      // refreshBalance();
    });

    // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
    window.addEventListener('beforeunload', function () {
      stopStatusTimer();
    });
  </script>
</body>

</html>

</html>
